// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider = "prisma-client"
  output   = "../generated/prisma"
}

datasource db {
  provider = "postgresql"
}
////////////////////////////////
// ENUMS
////////////////////////////////

enum Role {
  admin
  user
}

enum PaymentStatus {
  PENDING
  SETTLEMENT
  CANCEL
  EXPIRE
}

enum StatusWorkshops {
  upcoming
  ongoing
  completed
}

enum CreditTransactionType {
  TOPUP
  PURCHASE_WORKSHOP
  REFUND
  ADJUSTMENT
}

////////////////////////////////
// USERS & AUTH
////////////////////////////////

model User {
  id        String @id @default(uuid()) @db.Uuid

  email     String @unique
  username  String
  password  String
  phone     String?

  role      Role   @default(user)

  created_at DateTime @default(now())
  updated_at DateTime?

  refresh_tokens RefreshToken[]
  workshops      Workshop[]
  selected_workshops SelectedWorkshop[]
  workshop_ratings  WorkshopRating[]
  liked_workshops   LikedWorkshop[]

  wallet             UserWallet?
  credit_transactions CreditTransaction[]
  package_payments    PackagePayment[]
  workshop_credit_purchases WorkshopCreditPurchase[]

  @@map("users")
}

model RefreshToken {
  id         String @id @default(uuid()) @db.Uuid
  user_id   String @db.Uuid

  token      String @unique
  expires_at DateTime
  revoked_at DateTime?

  created_at DateTime @default(now())
  updated_at DateTime?

  user User @relation(fields: [user_id], references: [id])

  @@index([user_id])
  @@index([expires_at])
  @@map("refresh_tokens")
}

////////////////////////////////
// WORKSHOPS
////////////////////////////////

model Workshop {
  id String @id @default(uuid()) @db.Uuid

  title       String
  description String
  thumbnail   String

  benefits String[]
  category String

  short_description String

  credit_price Int?

  user_id String @db.Uuid

  created_at DateTime @default(now())
  updated_at DateTime?
  deleted_at DateTime?

  user User @relation(fields: [user_id], references: [id])

  modules          WorkshopModule[]
  selected_users   SelectedWorkshop[]
  ratings          WorkshopRating[]
  liked_users      LikedWorkshop[]
  credit_purchases WorkshopCreditPurchase[]

  @@map("workshops")
}

model WorkshopModule {
  id String @id @default(uuid()) @db.Uuid

  workshop_id String @db.Uuid

  title String
  type  String

  schedule_at DateTime

  youtube_url        String?
  zoom_url           String?
  whatsapp_group_url String?
  exam_form_url      String?

  description  String?
  content_text String?

  order Int

  created_at DateTime @default(now())
  updated_at DateTime?

  workshop Workshop @relation(fields: [workshop_id], references: [id])

  @@map("workshop_modules")
}

model SelectedWorkshop {
  id String @id @default(uuid()) @db.Uuid

  user_id     String @db.Uuid
  workshop_id String @db.Uuid

  created_at DateTime @default(now())
  updated_at DateTime?

  user     User     @relation(fields: [user_id], references: [id])
  workshop Workshop @relation(fields: [workshop_id], references: [id])

  @@unique([user_id, workshop_id])
  @@index([user_id])
  @@index([workshop_id])
  @@map("selected_workshops")
}

model WorkshopRating {
  id String @id @default(uuid()) @db.Uuid

  user_id     String @db.Uuid
  workshop_id String @db.Uuid

  rating Int
  review String?

  created_at DateTime @default(now())
  updated_at DateTime?

  user     User     @relation(fields: [user_id], references: [id])
  workshop Workshop @relation(fields: [workshop_id], references: [id])

  @@unique([user_id, workshop_id])
  @@index([workshop_id])
  @@map("workshop_ratings")
}

model LikedWorkshop {
  id String @id @default(uuid()) @db.Uuid

  user_id     String @db.Uuid
  workshop_id String @db.Uuid

  created_at DateTime @default(now())
  updated_at DateTime?

  user     User     @relation(fields: [user_id], references: [id])
  workshop Workshop @relation(fields: [workshop_id], references: [id])

  @@index([user_id])
  @@index([workshop_id])
  @@map("liked_workshops")
}

////////////////////////////////
// CREDIT SYSTEM
////////////////////////////////

model UserWallet {
  id String @id @default(uuid()) @db.Uuid

  user_id String @unique @db.Uuid
  balance Int @default(0)

  created_at DateTime @default(now())
  updated_at DateTime?

  user User @relation(fields: [user_id], references: [id])

  @@index([user_id])
  @@map("user_wallets")
}

model CreditTransaction {
  id String @id @default(uuid()) @db.Uuid

  user_id String @db.Uuid

  type   CreditTransactionType
  amount Int

  balance_before Int
  balance_after  Int

  reference_id String? @db.Uuid
  description  String?

  created_at DateTime @default(now())

  user User @relation(fields: [user_id], references: [id])

  @@index([user_id])
  @@index([type])
  @@map("credit_transactions")
}

////////////////////////////////
// CREDIT PACKAGE
////////////////////////////////

model PricingPackage {
  id String @id @default(uuid()) @db.Uuid

  package_id String @unique
  name String

  price Decimal @db.Decimal(10, 2)

  credits Int
  bonus   Int

  bonus_label String?
  validity    String?

  description String?
  highlight   String?

  created_at DateTime @default(now())

  payments PackagePayment[]

  @@map("pricing_packages")
}

////////////////////////////////
// CREDIT PAYMENTS (TOPUP)
////////////////////////////////

model PackagePayment {
  id String @id @default(uuid()) @db.Uuid

  user_id    String @db.Uuid
  package_id String @db.Uuid

  order_id String @unique

  transaction_token String?
  redirect_url      String?

  amount Decimal @db.Decimal(10, 2)

  status PaymentStatus @default(PENDING)
  idempotency_key String? @unique

  created_at DateTime @default(now())
  updated_at DateTime?

  user    User           @relation(fields: [user_id], references: [id])
  package PricingPackage @relation(fields: [package_id], references: [id])

  @@index([user_id])
  @@index([package_id])
  @@index([status])
  @@map("package_payments")
}

////////////////////////////////
// WORKSHOP CREDIT PURCHASE
////////////////////////////////

model WorkshopCreditPurchase {
  id String @id @default(uuid()) @db.Uuid

  user_id     String @db.Uuid
  workshop_id String @db.Uuid

  credit_used Int

  created_at DateTime @default(now())

  user     User     @relation(fields: [user_id], references: [id])
  workshop Workshop @relation(fields: [workshop_id], references: [id])

  @@unique([user_id, workshop_id])
  @@index([user_id])
  @@index([workshop_id])
  @@map("workshop_credit_purchases")
}
